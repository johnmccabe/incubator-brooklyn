#! /bin/sh

### BEGIN INIT INFO
# Provides:          brooklyn
# Required-Start:    $remote_fs $network $syslog
# Required-Stop:     $remote_fs $network $syslog
# Default-Start:      2 3 4 5
# Default-Stop:       0 1 6
# Short-Description: Starts the Apache Brooklyn service
### END INIT INFO
#
# brooklyn         Startup script for brooklyn.
#

NAME="brooklyn"
DESC="apache-brooklyn service"

INIT_CMD=$1

RUN_AS="vagrant"

JSVC_BIN="/usr/bin/jsvc"

JAVA_OPTS="-Xms256m -Xmx1g -XX:MaxPermSize=256m"
JAVA_HOME="/usr/lib/jvm/default-java"

BROOKLYN_HOME="/home/vagrant/brooklyn-dist-0.9.0-SNAPSHOT"
BROOKLYN_DAEMON_CLASS="org.apache.brooklyn.cli.Main"
BROOKLYN_CLASS_PATH="${BROOKLYN_HOME}/conf:${BROOKLYN_HOME}/lib/patch/*:${BROOKLYN_HOME}/lib/brooklyn/*:${BROOKLYN_HOME}/lib/dropins/*"
BROOKLYN_PIDFILE="/var/run/$NAME.pid"
BROOKLYN_ARGS="launch"

LOG_STDOUT="/var/log/brooklyn/$NAME.stdout"
LOG_STDERR="/var/log/brooklyn/$NAME.stderr"

# The file that will contain our process identification number (pid) for other scripts/programs that need to access it.

# System.out writes to this file...
LOG_OUT="$BROOKLYN_HOME/log/$NAME.out"

# System.err writes to this file...
LOG_ERR="$BROOKLYN_HOME/err/$NAME.err"

jsvc_exec()
{
    JSVC_CMD=$1
    cd $BROOKLYN_HOME
    $JSVC_BIN -home $JAVA_HOME \
              -cp $BROOKLYN_CLASS_PATH \
              -user $RUN_AS \
              -outfile $LOG_STDOUT \
              -errfile $LOG_STDERR \
              -pidfile $BROOKLYN_PIDFILE \
              $JSVC_CMD \
              $BROOKLYN_DAEMON_CLASS \
              $BROOKLYN_ARGS
}

case "$INIT_CMD" in
    start)
        echo "Starting $DESC"
        jsvc_exec
        echo "$DESC started"
        ;;
    stop)
        echo "Stopping $DESC"
        jsvc_exec "-stop"
        echo "$DESC stopped"
        ;;
    restart)
        if [ -f "$PID" ]; then
            echo "Restarting $DESC"
            jsvc_exec "-stop"
            jsvc_exec
            echo "$DESC has restarted"
        else
            echo "$DESC not running, no action taken"
            exit 1
        fi
        ;;
    *)
    echo "Usage: /etc/init.d/$NAME {start|stop|restart}" >&2
    exit 3
    ;;
esac